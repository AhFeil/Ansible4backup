# ===============================
# 0. 确保 ~/.local/bin 存在，以及为环境变量
# ===============================
- name: Ensure ~/.local/bin exists
  file:
    path: "{{ ansible_env.HOME }}/.local/bin"
    state: directory
    mode: '0755'

- name: Ensure ~/.local/bin is in PATH (.bashrc)
  lineinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    state: present


# ===============================
# 1. 检查 rclone 是否已安装
# ===============================
- name: Check if 'rclone' is installed (first check)
  stat:
    path: "{{ ansible_env.HOME }}/.local/bin/rclone"
  register: rclone_installed


- name: Check rclone version
  command: "{{ ansible_env.HOME }}/.local/bin/rclone version"
  register: rclone_version
  changed_when: false
  when: rclone_installed.stat.exists


# ===============================
# 2. 下载 rclone 压缩包
# ===============================
- name: Download rclone archive
  get_url:
    url: https://downloads.rclone.org/rclone-current-linux-amd64.zip
    dest: /tmp/rclone-current-linux-amd64.zip
    mode: '0644'
  environment:
    http_proxy: "{{ http_and_socks_proxy | default('') }}"
    https_proxy: "{{ http_and_socks_proxy | default('') }}"
  when: not rclone_installed.stat.exists


# ===============================
# 3. 解压 rclone
# ===============================
- name: Unzip rclone archive
  unarchive:
    src: /tmp/rclone-current-linux-amd64.zip
    dest: /tmp
    remote_src: true
  when: not rclone_installed.stat.exists


# ===============================
# 4. 安装 rclone 二进制（用户级）
# ===============================
- name: Install rclone binary to ~/.local/bin
  shell: |
    set -e
    mv /tmp/rclone-*-linux-amd64/rclone "{{ ansible_env.HOME }}/.local/bin/rclone"
    chmod 0755 "{{ ansible_env.HOME }}/.local/bin/rclone"
  when: not rclone_installed.stat.exists


# ===============================
# 5. 二次校验
# ===============================
- name: Check if 'rclone' is installed (second check)
  stat:
    path: "{{ ansible_env.HOME }}/.local/bin/rclone"
  register: rclone_installed

- name: Fail if 'rclone' is still not installed after the attempt
  fail:
    msg: "'rclone' is not installed and the manual installation failed."
  when: not rclone_installed.stat.exists


# ===============================
# 6. 读取已有 rclone remotes
# ===============================
- name: List existing rclone remotes
  command: "{{ ansible_env.HOME }}/.local/bin/rclone listremotes"
  register: rclone_remotes
  changed_when: false
  failed_when: false
  when: rclone_installed.stat.exists


# ===============================
# 7. 配置 WebDAV remote（幂等）
# ===============================
- name: Configure rclone WebDAV remote
  shell: >
    {{ ansible_env.HOME }}/.local/bin/rclone config create {{ rclone_remote_name }} webdav
    url={{ rclone_webdav_url }}
    vendor={{ rclone_webdav_vendor }}
    user={{ rclone_webdav_user }}
    pass={{ rclone_webdav_password }}
  when:
    - rclone_installed.stat.exists
    - rclone_remote_name + ":" not in rclone_remotes.stdout


# ===============================
# 8. 测试 WebDAV remote
# ===============================
- name: Test rclone WebDAV configuration
  command: "{{ ansible_env.HOME }}/.local/bin/rclone lsd {{ rclone_remote_name }}:"
  register: rclone_test
  failed_when: rclone_test.rc != 0
  when: rclone_installed.stat.exists

# ===============================
# 9. 创建 crypt remote（幂等）
# ===============================
- name: Fail if encryption is enabled but crypt secrets are missing
  fail:
    msg: >
      Encryption is enabled (in_encryption=true),
      but rclone_crypt_password or rclone_crypt_salt is not set.
  when:
    - in_encryption | default(false) | bool
    - rclone_crypt_password is not defined
      or rclone_crypt_password | length == 0
      or rclone_crypt_salt is not defined
      or rclone_crypt_salt | length == 0

- name: Set rclone crypt variables
  set_fact:
    rclone_crypt_dir_name: "encrypted_{{ backup_dir_name }}"
    rclone_crypt_remote_name: "crypt_{{ rclone_remote_name }}"

- name: Select final rclone target remote
  set_fact:
    rclone_target_remote: >-
      {{
        (in_encryption | default(false) | bool)
        | ternary(rclone_crypt_remote_name, rclone_remote_name)
      }}

- name: Configure rclone crypt remote
  shell: >
    {{ ansible_env.HOME }}/.local/bin/rclone config create {{ rclone_crypt_remote_name }} crypt
    remote={{ rclone_remote_name }}:{{ rclone_crypt_dir_name }}
    filename_encryption=standard
    directory_name_encryption=false
    password={{ rclone_crypt_password }}
    password2={{ rclone_crypt_salt }}
  when:
    - in_encryption | default(false) | bool
    - rclone_crypt_remote_name ~ ':' not in rclone_remotes.stdout
