
- name: List all backup files in MinIO directory
  command: "mc ls --json {{ minio_alias }}/{{ bucket_name }}/{{ specify_directory_in_bucket }}/"
  register: minio_files
- name: Extract and sort backup filenames (newest first)
  set_fact:
    sorted_backups: >-
      {{
        (minio_files.stdout_lines | default([])
        | map('from_json')
        | selectattr('type', '==', 'file')
        | map(attribute='key')
        | list
        | sort(reverse=true))
      }}
- name: Remove oldest backup files
  command: "mc rm {{ minio_alias }}/{{ bucket_name }}/{{ specify_directory_in_bucket }}/{{ item }}"
  loop: "{{ sorted_backups[max_backups:] }}"
  when: sorted_backups | length > max_backups
