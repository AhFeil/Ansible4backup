- name: check storage space
  ansible.builtin.import_tasks: ../../check_storage_space/tasks/main.yaml
- name: set up rclone
  ansible.builtin.import_tasks: ../../my_rclone_client_role/tasks/main.yaml


# 创建临时放置导出的备份文件的目录
- name: Create directory
  ansible.builtin.file:
    path: "{{ temporary_store_directory }}"
    state: directory

# 导出要备份的内容
- name: Backup PostgreSQL database
  become: true
  ansible.builtin.shell:
    cmd: "docker exec --env-file=/matrix/postgres/env-postgres-psql matrix-postgres /usr/local/bin/pg_dumpall -h matrix-postgres | gzip -c > {{ temporary_store_directory }}/{{ backup_date }}_postgres.sql.gz"
- name: Backup media files
  become: true
  ansible.builtin.shell:
    cmd: "tar -zc -f {{ temporary_store_directory }}/{{ backup_date }}_media_bak_matrix.tar.gz /matrix/synapse/storage/media-store -p"

- name: Change owner
  become: true
  file:
    path: "{{ temporary_store_directory }}"
    owner: "{{ansible_env.USER}}"
    recurse: yes

- name: Upload backup files via rclone
  command: "{{ ansible_env.HOME }}/.local/bin/rclone copy {{ temporary_store_directory }}/ {{ rclone_target_remote }}:{{ backup_dir_name }}/{{ specify_directory_in_remote }}/"
  notify:
    - Remove backup files on local

- name: clear backups
  ansible.builtin.import_tasks: ../../my_rclone_client_role/tasks/clear.yaml
